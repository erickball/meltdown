<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Meltdown - Nuclear Power Plant Simulator</title>
    <link rel="stylesheet" href="/src/style.css" />
  </head>
  <body>
    <div id="app">
      <canvas id="plant-canvas"></canvas>
      <div id="toolbar">
        <h3>Mode</h3>
        <div class="mode-controls">
          <button id="mode-construction" class="mode-btn active">üîß Construction</button>
          <button id="mode-simulation" class="mode-btn">‚ñ∂Ô∏è Simulation</button>
        </div>

        <!-- Simulation Controls Section -->
        <div class="sim-controls" id="sim-controls" style="display: none;">
          <hr />
          <h3>Simulation</h3>
          <div class="history-controls" style="margin-bottom: 5px;">
            <button id="back-step-btn" class="sim-btn" title="Back one step in history">‚èÆ</button>
            <button id="forward-step-btn" class="sim-btn" title="Forward one step in history">‚è≠</button>
            <button id="pause-btn" class="sim-btn">‚ñ∂ Resume</button>
            <button id="run-one-step-btn" class="sim-btn" title="Run one simulation step">Run 1 Step</button>
          </div>
          <div class="history-controls" style="margin-bottom: 5px;">
            <button id="goto-time-btn" class="sim-btn" title="Go to time...">Go To...</button>
            <button id="reset-sim-btn" class="sim-btn" title="Jump to t=0" style="background: #654;">‚Ü∫ t=0</button>
            <span id="history-info" style="font-size: 10px; color: #888; margin-left: 5px;"></span>
          </div>
          <div class="speed-controls">
            <button id="speed-down" class="sim-btn small">‚àí</button>
            <span id="speed-display">1x</span>
            <button id="speed-up" class="sim-btn small">+</button>
          </div>
          <div class="speed-presets">
            <button class="speed-preset" data-speed="0.01">0.01x</button>
            <button class="speed-preset" data-speed="0.1">0.1x</button>
            <button class="speed-preset" data-speed="1">1x</button>
            <button class="speed-preset" data-speed="10">10x</button>
            <button class="speed-preset" data-speed="100">100x</button>
          </div>
          <div class="slowdown-control">
            <label for="slowdown-threshold">
              <input type="checkbox" id="auto-slowdown-enabled" checked />
              Auto-slow at <span id="slowdown-threshold-value">10</span>%
            </label>
            <input type="range" id="slowdown-threshold" min="5" max="400" value="10" step="5" />
          </div>
          <details style="margin-top: 10px;" open>
            <summary style="cursor: pointer; color: #7af;">Advanced Solver Settings</summary>
            <div class="solver-settings" style="margin-top: 8px; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 4px;">
              <div class="timestep-control" style="margin-bottom: 8px;">
                <label for="max-timestep" style="font-size: 11px;">
                  Max timestep: <span id="max-timestep-value">500</span>ms
                </label>
                <input type="range" id="max-timestep" min="1" max="1000" value="500" step="10" style="width: 100%;" />
              </div>
              <div class="slider-control" style="margin-bottom: 8px;">
                <label for="min-timestep" style="font-size: 11px;">
                  Min timestep: <span id="min-timestep-value">1</span>¬µs
                </label>
                <input type="range" id="min-timestep" min="0" max="5" value="0" step="0.1" style="width: 100%;" />
                <div class="slider-labels" style="font-size: 9px;"><span>1¬µs</span><span>100ms</span></div>
              </div>
              <div class="pressure-model-control" style="margin-bottom: 8px;">
                <label for="pressure-model" style="font-size: 11px;">Pressure Model:</label>
                <select id="pressure-model" style="margin-left: 5px;">
                  <option value="hybrid">Hybrid (Bulk Modulus)</option>
                  <option value="pure-triangulation" selected>Pure Triangulation</option>
                </select>
              </div>
              <div class="slider-control" style="margin-bottom: 8px;">
                <label for="k-max" style="font-size: 11px;">
                  K_max: <span id="k-max-value">2200</span> MPa
                </label>
                <input type="range" id="k-max" min="25" max="2200" value="2200" step="25" style="width: 100%;" />
                <div class="slider-labels" style="font-size: 9px;"><span>25 MPa</span><span>2200 MPa</span></div>
              </div>
              <div style="margin-top: 8px;">
                <label style="font-size: 11px;">
                  <input type="checkbox" id="pressure-solver-enabled" />
                  Enable pressure solver
                </label>
              </div>
            </div>
          </details>
          <hr />
          <h3>Control Rods</h3>
          <div class="slider-control">
            <label for="rod-position">Insertion: <span id="rod-position-value">15%</span></label>
            <input type="range" id="rod-position" min="0" max="100" value="15" />
            <div class="slider-labels"><span>Out</span><span>In</span></div>
          </div>
          <div class="scram-controls" style="margin-top: 10px;">
            <button id="scram-btn" class="sim-btn" style="background: #d00; color: white; font-weight: bold;">SCRAM</button>
            <button id="reset-scram-btn" class="sim-btn" style="display: none;">Reset SCRAM</button>
            <div id="scram-indicator" style="display: none; color: #d00; font-weight: bold; margin-top: 5px;">
              ‚ö†Ô∏è REACTOR SCRAMMED
            </div>
          </div>
        </div>

        <!-- Construction Controls Section -->
        <div class="construction-controls" id="construction-controls">
          <hr />
          <h3>Components</h3>
        <div class="component-categories">
          <details open>
            <summary>Vessels</summary>
            <button data-component="tank" class="component-btn">Tank</button>
            <button data-component="pressurizer" class="component-btn">Pressurizer</button>
          </details>
          <details open>
            <summary>Flow</summary>
            <button data-component="pipe" class="component-btn">Pipe</button>
            <button data-component="valve" class="component-btn">Valve</button>
            <button data-component="check-valve" class="component-btn">Check Valve</button>
            <button data-component="relief-valve" class="component-btn">Relief Valve</button>
            <button data-component="porv" class="component-btn">PORV</button>
            <button data-component="pump" class="component-btn">Pump</button>
          </details>
          <details open>
            <summary>Heat Transfer</summary>
            <button data-component="heat-exchanger" class="component-btn">Heat Exchanger</button>
            <button data-component="condenser" class="component-btn">Condenser</button>
          </details>
          <details open>
            <summary>Power</summary>
            <button data-component="turbine-generator" class="component-btn">Turbine-Generator</button>
            <button data-component="turbine-driven-pump" class="component-btn">Turbine-Driven Pump</button>
          </details>
          <details open>
            <summary>Nuclear</summary>
            <button data-component="reactor-vessel" class="component-btn">Reactor Vessel</button>
            <button data-component="core" class="component-btn">Reactor Core</button>
          </details>
          <details open>
            <summary>Controllers</summary>
            <button data-component="scram-controller" class="component-btn">Scram Controller</button>
          </details>
          <details open>
            <summary>Electrical</summary>
            <button data-component="switchyard" class="component-btn">Switchyard</button>
          </details>
        </div>
        <div class="construction-info" style="margin-top: 10px; font-size: 11px; color: #888;">
          <div id="selected-component">No component selected</div>
          <div id="placement-hint" style="display: none;">Click to place</div>
        </div>
        <hr />
        <h3>Connections</h3>
        <button id="connect-mode-btn" class="mode-btn">üîó Connect Components</button>
        <div id="connection-info" style="margin-top: 10px; font-size: 11px; color: #888; display: none;">
          <div id="connection-status">Select first component...</div>
        </div>

        <!-- Save/Load Section -->
        <hr />
        <button id="open-save-load-btn" class="mode-btn">üíæ Save / Load</button>
        </div>

        <!-- Common controls for both modes -->
        <hr />
        <h3>Edit</h3>
        <button id="move-mode" class="mode-btn">Move</button>
        <hr />
        <h3>View</h3>
        <button id="toggle-isometric" class="view-btn active">üéõÔ∏è 2.5D View</button>
        <div class="slider-control" style="margin: 8px 0;">
          <label for="view-elevation" style="font-size: 11px;">View Angle: <span id="view-elevation-value">30</span>¬∞</label>
          <input type="range" id="view-elevation" min="10" max="50" value="30" style="width: 100%;" />
        </div>
        <button id="zoom-in">Zoom +</button>
        <button id="zoom-out">Zoom -</button>
        <button id="reset-view">Reset View</button>
      </div>
      <div id="status-bar">
        <span id="mouse-pos">X: 0, Y: 0</span>
        <span id="sim-time">Time: 0.0s</span>
        <span id="sim-speed">Speed: 1x</span>
        <span id="perf-info">dt: 0ms</span>
      </div>
      <div id="construction-cost-panel" style="display: none;">
        <div id="cost-header">
          <span id="cost-toggle">‚ñ∂</span>
          <span class="cost-title">Overnight Cost:</span>
          <span id="total-cost">$0</span>
        </div>
        <div id="cost-breakdown" style="display: none;"></div>
      </div>
      <div id="mw-to-grid-panel" style="display: none;">
        <span class="mw-label">MW to Grid:</span>
        <span id="mw-value">0</span>
      </div>
      <div id="debug-panel">
        <h4>Debug <button id="toggle-debug">Hide</button></h4>
        <div id="debug-content">
          <div class="debug-section">
            <strong>Solver</strong>
            <div id="debug-solver"></div>
          </div>
          <div class="debug-section">
            <strong>Neutronics</strong>
            <div id="debug-neutronics"></div>
          </div>
          <div class="debug-section">
            <strong>Thermal Nodes</strong>
            <div id="debug-thermal"></div>
          </div>
          <div class="debug-section">
            <strong>Flow Nodes</strong>
            <div id="debug-flow"></div>
          </div>
          <div class="debug-section">
            <strong>Operator Timing</strong>
            <div id="debug-operators"></div>
          </div>
        </div>
      </div>
      <div id="component-detail" class="hidden">
        <h4>Selected Component <button id="close-detail">X</button></h4>
        <div id="component-detail-content"></div>
      </div>
      <!-- Color legend is now rendered on canvas -->
    </div>
    <!-- Component Configuration Dialog -->
    <div id="component-dialog" class="component-dialog" style="display: none;">
      <div class="dialog-content">
        <div class="dialog-header">
          <h3 id="dialog-title">Configure Component</h3>
          <button class="dialog-close">&times;</button>
        </div>
        <div id="dialog-body" class="dialog-body">
          <!-- Dynamic content will be inserted here -->
        </div>
        <div class="dialog-footer">
          <button id="dialog-cancel" class="btn-secondary">Cancel</button>
          <button id="dialog-confirm" class="btn-primary">Place Component</button>
        </div>
      </div>
    </div>

    <!-- Connection Configuration Dialog -->
    <div id="connection-dialog" class="component-dialog" style="display: none;">
      <div class="dialog-content">
        <div class="dialog-header">
          <h3 id="connection-dialog-title">Configure Connection</h3>
          <button class="connection-dialog-close">&times;</button>
        </div>
        <div id="connection-dialog-body" class="dialog-body">
          <!-- Dynamic content will be inserted here -->
        </div>
        <div class="dialog-footer">
          <button id="connection-dialog-cancel" class="btn-secondary">Cancel</button>
          <button id="connection-dialog-confirm" class="btn-primary">Create Connection</button>
        </div>
      </div>
    </div>

    <!-- History Navigation Dialog -->
    <div id="history-dialog" class="component-dialog" style="display: none;">
      <div class="dialog-content" style="max-width: 400px; max-height: 80vh;">
        <div class="dialog-header">
          <h3>Navigate to State</h3>
          <button class="history-dialog-close">&times;</button>
        </div>
        <div id="history-dialog-body" class="dialog-body" style="max-height: 50vh; overflow-y: auto;">
          <!-- Snapshot list will be inserted here -->
        </div>
        <div class="dialog-footer" style="flex-direction: column; gap: 8px;">
          <div style="display: flex; gap: 8px; align-items: center;">
            <label style="font-size: 12px;">Go to time:</label>
            <input type="number" id="history-time-input" step="0.1" min="0" style="width: 80px; padding: 4px;">
            <span style="font-size: 12px;">s</span>
            <button id="history-goto-time-btn" class="btn-primary" style="padding: 4px 8px;">Go</button>
          </div>
          <button id="history-dialog-cancel" class="btn-secondary">Close</button>
        </div>
      </div>
    </div>

    <script type="module" src="/src/main.ts"></script>
  </body>
</html>
